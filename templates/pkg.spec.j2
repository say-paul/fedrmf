{#- Jinja2 template for RMF package spec files -#}
{#- Similar to rosfed's pkg.spec.j2 template -#}
%global ros_distro {{ distro }}
%global pkg_name {{ package_name }}
%global upstream_name {{ package_name.replace('_', '-') }}

{% if vendor_package -%}
%global vendor_package 1
{% endif -%}

{% if qt_package -%}
%global qt_package 1
{% endif -%}

{% if skip_debug -%}
%global debug_package %{nil}
{% endif -%}
Name:           ros-{{ distro }}-{{ package_name.replace('_', '-') }}
Version:        {{ version }}
Release:        {{ release if release else 1 }}%{?dist}
Summary:        {{ description }}

License:        {{ license }}
URL:            {{ repository }}
Source0:        {{ repository }}/archive/refs/tags/{{ version }}.tar.gz#/{{ package_name }}-{{ version }}.tar.gz

{% if patches -%}
{% for patch in patches -%}
Patch{{ loop.index0 }}:        {{ patch }}
{% endfor -%}
{% endif -%}

# Build dependencies
BuildRequires:  cmake
BuildRequires:  gcc-c++
BuildRequires:  pkgconfig

{% if use_colcon -%}
BuildRequires:  python3-colcon-core
BuildRequires:  python3-colcon-ros
BuildRequires:  python3-colcon-common-extensions
{% endif -%}

{% if ros_distro -%}
BuildRequires:  ros-{{ distro }}-ament-cmake
{% endif -%}

{% for dep in build_depends -%}
BuildRequires:  {{ resolve_dependency(dep, distro) }}
{% endfor -%}

{% for dep in system_depends -%}
BuildRequires:  {{ dep }}
{% endfor -%}

{% if additional_build_deps -%}
{% for dep in additional_build_deps -%}
BuildRequires:  {{ dep }}
{% endfor -%}
{% endif -%}

# Runtime dependencies
{% if ros_distro -%}
Requires:       ros-{{ distro }}-rclcpp
{% endif -%}

{% for dep in exec_depends -%}
Requires:       {{ resolve_dependency(dep, distro) }}
{% endfor -%}

{% if additional_runtime_deps -%}
{% for dep in additional_runtime_deps -%}
Requires:       {{ dep }}
{% endfor -%}
{% endif -%}

{% if devel_package -%}

%package        devel
Summary:        Development files for %{name}
Requires:       %{name}%{?_isa} = %{version}-%{release}

%description devel
The %{name}-devel package contains libraries and header files for
developing applications that use %{name}.
{% endif -%}

%description
{{ description }}

{% if long_description -%}

{{ long_description }}
{% endif -%}

%prep
%autosetup -n {{ package_name }}-{{ version }}{% if patches %} -p1{% endif %}

%build
{% if build_env -%}
{% for key, value in build_env.items() -%}
export {{ key }}={{ value }}
{% endfor -%}
{% endif -%}
{% if use_colcon %}
# Build with colcon into a temporary local install directory
set -e
source /usr/lib64/ros2-{{ distro }}/setup.bash || true
colcon build \
  --merge-install \
  --base-paths {{ source_dir | default('.') }} \
  --install-base install \
  --cmake-args \
    -DPYTHON_EXECUTABLE=/usr/bin/python3 \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DBUILD_TESTING=OFF{% if cmake_args %} {{ cmake_args | join(' ') }}{% endif %}
{% else %}
%cmake -S {{ source_dir | default(package_name) }} -DCMAKE_BUILD_TYPE=RelWithDebInfo{% if cmake_args %} {{ cmake_args | join(" ") }}{% endif %}
%cmake_build
{% endif %}

%install
{% if use_colcon %}
# Copy the built files from the local install dir to the buildroot
mkdir -p %{buildroot}/%{_libdir}/ros2-{{ distro }}
if [ -d install/include ]; then cp -a install/include %{buildroot}/%{_libdir}/ros2-{{ distro }}/; fi
if [ -d install/lib ]; then cp -a install/lib %{buildroot}/%{_libdir}/ros2-{{ distro }}/; fi
if [ -d install/lib64 ]; then cp -a install/lib64 %{buildroot}/%{_libdir}/ros2-{{ distro }}/; fi
if [ -d install/share ]; then cp -a install/share %{buildroot}/%{_libdir}/ros2-{{ distro }}/; fi
{% else %}
%cmake_install
{% endif %}

{% if post_install_commands -%}
{% for cmd in post_install_commands -%}
{{ cmd }}
{% endfor -%}
{% endif -%}

{% if install_additional_files -%}
{% for file_spec in install_additional_files -%}
install -D -m {{ file_spec.mode | default('644') }} {{ file_spec.src }} %{buildroot}{{ file_spec.dest }}
{% endfor -%}
{% endif -%}

%check
{% if run_tests and not skip_tests -%}
{% if ros_distro -%}
export ROS_DISTRO={{ distro }}
export AMENT_PREFIX_PATH=/opt/ros/{{ distro }}
if [ -f /opt/ros/{{ distro }}/setup.bash ]; then
    source /opt/ros/{{ distro }}/setup.bash
fi
{% endif -%}
%ctest
{% else -%}
# Tests disabled
{% endif -%}

{% if pre_install_script -%}

%pre
{{ pre_install_script }}
{% endif -%}

{% if post_install_script -%}

%post
{{ post_install_script }}
{% if ldconfig_needed -%}
/sbin/ldconfig
{% endif -%}
{% endif -%}

{% if preun_script -%}

%preun
{{ preun_script }}
{% endif -%}

{% if postun_script -%}

%postun
{{ postun_script }}
{% if ldconfig_needed -%}
/sbin/ldconfig
{% endif -%}
{% endif -%}

%files
{% if custom_files -%}
{% for file_pattern in custom_files -%}
{{ file_pattern }}
{% endfor -%}
{% else -%}
%{_libdir}/ros2-{{ distro }}/*
{% endif -%}

{% if exclude_files -%}
{% for exclude_pattern in exclude_files -%}
%exclude {{ exclude_pattern }}
{% endfor -%}
{% endif -%}

{% if devel_package -%}

%files devel
{% for file_pattern in devel_files -%}
{{ file_pattern }}
{% endfor -%}
{% endif -%}

%changelog
{% if changelog -%}
{% for entry in changelog -%}
{{ entry.entry }}
{{ entry.message }}

{% endfor -%}
{% else -%}
* {{ build_date }} Sayan Paul <paul.sayan@gmail.com> - {{ version }}-{{ release|default(1) }}
- Initial build of {{ package_name }} for ROS {{ distro }}
{% endif %} 